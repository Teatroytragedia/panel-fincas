<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PANEL ANALÍTICO DE MICROORGANISMOS – FINCAS 2024–2025</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f5f5f5;
      text-align: center;
    }
    h1 {
      background-color: #0047AB;
      color: white;
      padding: 20px 0;
      margin-bottom: 20px;
      text-transform: uppercase;
    }
    .filtros {
      margin: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    select, input[type=file] {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: white;
    }
    .contenedor-graficos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      padding: 20px;
      justify-items: center;
    }
    canvas {
      width: 100%;
      max-width: 300px;
      height: 250px !important;
      background: white;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    canvas:hover {
      transform: scale(1.03);
    }
    #estado {
      color: #007700;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>PANEL ANALÍTICO DE MICROORGANISMOS – FINCAS 2024–2025</h1>

  <p id="estado"></p>

  <div class="filtros">
    <input type="file" id="inputExcel" accept=".xlsx,.xls" />
    <select id="filtroFinca"><option value="Todos">FINCA (TODAS)</option></select>
    <select id="filtroMicroorganismo"><option value="Todos">MICROORGANISMO (TODOS)</option></select>
    <select id="filtroNombre"><option value="Todos">NOMBRE (TODOS)</option></select>
    <select id="filtroFase"><option value="Todos">FASE (TODAS)</option></select>
    <select id="filtroTipo"><option value="Todos">TIPO (TODOS)</option></select>
  </div>

  <div class="contenedor-graficos">
    <canvas id="graficoFincas"></canvas>
    <canvas id="graficoMicroorganismos"></canvas>
    <canvas id="graficoFases"></canvas>
    <canvas id="graficoPastel"></canvas>
  </div>

  <script>
    let datos = [];
    let graficos = {};

    document.getElementById('inputExcel').addEventListener('change', leerExcel);

    function leerExcel(e) {
      const archivo = e.target.files[0];
      const lector = new FileReader();
      lector.onload = function(evento) {
        const datosBinarios = new Uint8Array(evento.target.result);
        const libro = XLSX.read(datosBinarios, { type: 'array' });
        const hoja = libro.Sheets[libro.SheetNames[0]];
        datos = XLSX.utils.sheet_to_json(hoja);

        // Limpieza de espacios en encabezados
        datos = datos.map(fila => {
          const limpio = {};
          Object.keys(fila).forEach(k => {
            limpio[k.trim().toUpperCase()] = fila[k];
          });
          return limpio;
        });

        document.getElementById("estado").textContent = "✅ DATOS CARGADOS CORRECTAMENTE";
        inicializarFiltros();
        actualizarGraficos();
      };
      lector.readAsArrayBuffer(archivo);
    }

    function inicializarFiltros() {
      llenarFiltro('filtroFinca', 'FINCA');
      llenarFiltro('filtroMicroorganismo', 'MICROORGANISMO');
      llenarFiltro('filtroNombre', 'NOMBRE');
      llenarFiltro('filtroFase', 'FASE');
      llenarFiltro('filtroTipo', 'TIPO');
    }

    function llenarFiltro(idFiltro, campo) {
      const filtro = document.getElementById(idFiltro);
      const valores = [...new Set(datos.map(d => (d[campo] || '').toString().trim()))];
      filtro.innerHTML = `<option value="Todos">${campo} (TODOS)</option>` +
                         valores.map(v => `<option value="${v}">${v}</option>`).join('');
      filtro.addEventListener('change', actualizarGraficos);
    }

    function filtrarDatos() {
      const finca = document.getElementById('filtroFinca').value;
      const micro = document.getElementById('filtroMicroorganismo').value;
      const nombre = document.getElementById('filtroNombre').value;
      const fase = document.getElementById('filtroFase').value;
      const tipo = document.getElementById('filtroTipo').value;

      return datos.filter(d =>
        (finca === 'Todos' || d.FINCA === finca) &&
        (micro === 'Todos' || d.MICROORGANISMO === micro) &&
        (nombre === 'Todos' || d.NOMBRE === nombre) &&
        (fase === 'Todos' || d.FASE === fase) &&
        (tipo === 'Todos' || d.TIPO === tipo)
      );
    }

    function actualizarGraficos() {
      const datosFiltrados = filtrarDatos();
      crearGraficoBarras('graficoFincas', 'FINCA', 'Distribución por Finca', datosFiltrados);
      crearGraficoBarras('graficoMicroorganismos', 'MICROORGANISMO', 'Tipos de Microorganismos', datosFiltrados);
      crearGraficoBarras('graficoFases', 'FASE', 'Fases del Estudio', datosFiltrados);
      crearGraficoPastel('graficoPastel', 'TIPO', 'Benéficos vs Patógenos', datosFiltrados);
    }

    function crearGraficoBarras(id, campo, titulo, datos) {
      const ctx = document.getElementById(id).getContext('2d');
      const conteo = {};
      datos.forEach(d => {
        const valor = d[campo] || 'Sin dato';
        conteo[valor] = (conteo[valor] || 0) + 1;
      });

      const etiquetas = Object.keys(conteo);
      const valores = Object.values(conteo);

      if (graficos[id]) graficos[id].destroy();

      graficos[id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [{
            label: titulo,
            data: valores,
            backgroundColor: '#0047AB'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          animation: { duration: 700 },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function crearGraficoPastel(id, campo, titulo, datos) {
      const ctx = document.getElementById(id).getContext('2d');
      const conteo = {};
      datos.forEach(d => {
        const valor = d[campo] || 'Sin dato';
        conteo[valor] = (conteo[valor] || 0) + 1;
      });

      const etiquetas = Object.keys(conteo);
      const valores = Object.values(conteo);
      const colores = etiquetas.map(v => v.toLowerCase().includes('hongo') ? '#ff7f0e' : '#1f77b4');

      if (graficos[id]) graficos[id].destroy();

      graficos[id] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: etiquetas,
          datasets: [{
            data: valores,
            backgroundColor: colores
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const valor = context.parsed;
                  const porcentaje = ((valor / total) * 100).toFixed(1);
                  return `${context.label}: ${porcentaje}%`;
                }
              }
            }
          },
          animation: { duration: 700 }
        }
      });
    }
  </script>
</body>
</html>
